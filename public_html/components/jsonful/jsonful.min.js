(function(){var t,e,n,r,s,i,o,u,c,h,l=[].slice,a={}.hasOwnProperty,f=function(t,e){function n(){this.constructor=t}for(var r in e)a.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=function(){function t(){this.events={}}return t.prototype.emit=function(){var t,e,n,r,s,i;if(e=arguments[0],t=2<=arguments.length?l.call(arguments,1):[],!this.events[e])return!1;for(i=this.events[e],n=0,r=i.length;r>n;n++)s=i[n],s.apply(null,t);return!0},t.prototype.addListener=function(t,e){var n;return this.emit("newListener",t,e),(null!=(n=this.events)[t]?n[t]:n[t]=[]).push(e),this},t.prototype.on=t.prototype.addListener,t.prototype.once=function(t,e){var n;return n=function(r){return function(){return r.removeListener(t,n),e.apply(null,arguments)}}(this),this.on(t,n),this},t.prototype.removeListener=function(t,e){var n;return this.events[t]?(this.events[t]=function(){var r,s,i,o;for(i=this.events[t],o=[],r=0,s=i.length;s>r;r++)n=i[r],n!==e&&o.push(n);return o}.call(this),this):this},t.prototype.removeAllListeners=function(t){return delete this.events[t],this},t}(),u={},h=setTimeout,o=function(t,e){var n,r;for(n in e)a.call(e,n)&&(r=e[n],t[n]=r);return t},e=function(t){function e(t){this.server=t,this._queue=[],this._headers={},this._callback=this._sendRequest.bind(this),e.__super__.constructor.call(this),this.on("session",function(t){return this._headers.session=t}.bind(this))}return f(e,t),e.prototype._xhrRequest=function(t,n){var r;return r=e.getXhr(),r.onload=n,r.onerror=function(){var e,s,i,o;try{o=r.response||r.responseText}catch(i){e=i,o=""}return s=new Error(o),s.status=r.status,this.emit("error",s,function(){return this._xhrRequest(t,n)}.bind(this))}.bind(this),this.emit("request"),r.open("POST",this.server,!0),r.responseType="json",r.setRequestHeader("Content-Type","application/json"),r.send(JSON.stringify(o({requests:t},this._headers)))},e.prototype.handle_responses=function(t,e){var n,r,s;r=[];for(n in t)a.call(t,n)&&(s=t[n],"object"==typeof s&&s.error?r.push(e[n].failure(s)):r.push(e[n].success(s)));return r},e.prototype._sendRequest=function(){var t,e,n;return t=this._queue,e=t.map(function(t){return[t.name,t.args]}),n=this,this._xhrRequest(e,function(){var r,s,i,o,u,c;try{o=this.response||"string"!=typeof this.responseText?this.response:JSON.parse(this.responseText)}catch(s){r=s,o=""}if(n.emit("response"),!(o&&o instanceof Object&&o.responses instanceof Array))return void n.emit("error",new Error("Invalid response from the server"),e);u=[];for(i in o)a.call(o,i)&&(c=o[i],"function"==typeof n["handle_"+i]?u.push(n["handle_"+i](c,t)):u.push(n.emit(i,c)));return u}),this._queue=[]},e.prototype.setSession=function(t){return this._headers.session=t,this},e.prototype.exec=function(t,e,r){var s;return null==e&&(e=[]),null==r&&(r=null),"function"==typeof e&&(r=e,e=[]),s=new n(function(n,r){return this._queue.push({name:t,args:e,success:n,failure:r})}.bind(this)),"function"==typeof r&&(s.then(function(t){return r(null,t)}),s["catch"](function(t){return r(t,null)})),clearTimeout(this._sender),this._sender=setTimeout(this._callback),s},e}(t),e.getXhr=function(){return new XMLHttpRequest},this.JSONful=e,this.Promise=n,this.EventEmitter=t,c=Array.prototype.push,i=function(t){return"function"==typeof t},s=function(t){return t},r=function(t){throw t},u.exports=n=function(){function t(t){var e,n,r,s;this._reactions=[],s=this._resolve(!0),r=this._resolve(!1);try{t(s,r)}catch(n){e=n,r(e)}}return t.prototype.then=function(t,e){return i(t)||(t=s),i(e)||(e=r),new this.constructor(function(n){return function(r,s){var i;return(i=n._settled?h:c.bind(n._reactions))(function(){var i,o,u,c;i=n._success?t:e;try{c=i(n._result)}catch(u){return o=u,s(o)}return r(c)})}}(this))},t.prototype["catch"]=function(t){return this.then(null,t)},t.prototype._resolve=function(t){return function(e){return function(n){var r,s,i,o;if(!e._resolved){if(e._resolved=!0,t){if(n===e)return o=new TypeError("can't resolve a promise with itself"),e._settle(!1,o);try{i=e.constructor._normalizeThenable(n)}catch(s){return r=s,e._settle(!1,r)}if(i)return void i.then(function(t){return e._settle(!0,t)},function(t){return e._settle(!1,t)})}return e._settle(t,n)}}}(this)},t.prototype._settle=function(t,e){var n,r,s,i;if(!this._settled){for(this._settled=!0,this._success=t,this._result=e,i=this._reactions,n=0,r=i.length;r>n;n++)s=i[n],h(s);return this._reactions=null}},t.resolve=function(t){var e,n,r;try{r=this._normalizeThenable(t)}catch(n){return e=n,this.reject(e)}return r||new this(function(e,n){return e(t)})},t.reject=function(t){return new this(function(e,n){return n(t)})},t._normalizeThenable=function(t){var e,n;return n=null!=t?t.then:void 0,i(n)?t instanceof this?t:"boolean"==(e=typeof t)||"number"===e?!1:new this(function(e,r){return n.call(t,e,r)}):!1},t}()}).call(this);