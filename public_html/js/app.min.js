!function(e,t,a,n,r){function l(e,t){if(t||(t=[]),4===t.length)return e.encrypt(t);for(var a=[],n=0;n<t.length;n+=4)a=a.concat(e.encrypt([t[n],t[n+1],t[n+2],t[n+3]]));return a}function s(e,t){if(4===t.length)return e.decrypt(t);for(var a=[],n=0;n<t.length;n+=4)a=a.concat(e.decrypt([t[n],t[n+1],t[n+2],t[n+3]]));return a}function o(e){if(e+="==".substr(2-3*e.length&3),"function"==typeof atob){e=e.replace(/\-/g,"+").replace(/_/g,"/").replace(/,/g,"");try{return atob(e)}catch(t){return""}}var a,n,r,l,s,i,o,c,m=0,u=0,d="",p=[];if(!e)return e;e+="";do l=b64.indexOf(e.charAt(m++)),s=b64.indexOf(e.charAt(m++)),i=b64.indexOf(e.charAt(m++)),o=b64.indexOf(e.charAt(m++)),c=l<<18|s<<12|i<<6|o,a=c>>16&255,n=c>>8&255,r=255&c,64===i?p[u++]=String.fromCharCode(a):64===o?p[u++]=String.fromCharCode(a,n):p[u++]=String.fromCharCode(a,n,r);while(m<e.length);return d=p.join("")}function c(e){if("function"==typeof btoa)return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"");var t,a,n,r,l,s,i,o,c=0,m=0,u="",d=[];do t=e.charCodeAt(c++),a=e.charCodeAt(c++),n=e.charCodeAt(c++),o=t<<16|a<<8|n,r=o>>18&63,l=o>>12&63,s=o>>6&63,i=63&o,d[m++]=b64a[r]+b64a[l]+b64a[s]+b64a[i];while(c<e.length);u=d.join("");var p=e.length%3;return p?u.slice(0,p-3):u}function m(e){for(var t="",a=0;a<4*e.length;a++)t+=String.fromCharCode(e[a>>2]>>>24-8*(3&a)&255);return t}function u(e){return h(o(e))}function d(e){return c(m(e))}function p(e,t){"string"==typeof t&&(t=new sjcl.cipher.aes(f(t)));var a=h(e),n=[0,0,0,0];for(i=0;i<a.length;i++)n[3&i]^=a[i];for(i=16384;i--;)n=t.encrypt(n);return d([n[0],n[2]])}function h(e){for(var t=Array(e.length+3>>2),a=0;a<e.length;a++)t[a>>2]|=e.charCodeAt(a)<<24-8*(3&a);return t}function f(e){return b(h(e))}function b(e){var t,a,n,r=[],l=[2479122403,2108737444,3518906241,22203222];for(a=0;a<e.length;a+=4){for(key=[0,0,0,0],t=0;4>t;t++)t+a<e.length&&(key[t]=e[t+a]);r.push(new sjcl.cipher.aes(key))}for(n=65536;n--;)for(a=0;a<r.length;a++)l=r[a].encrypt(l);return l}function E(){D={}}function v(){var e=HashRouter.url.apply(HashRouter,arguments);t.location.hash=e}function y(){$("textarea.markdown").each(function(){D[$(this).attr("name")]=new SimpleMDE({element:this,autoDownloadFontAwesome:!1,spellChecker:!1,previewRender:function(e){return e=e.replace(/(#+)(.)/,"$1 $2"),e=e.replace(/\(([0-9a-f]{24})\)/gi,"(attach.php?id=$1)"),this.parent.markdown(e)}})}),$("textarea.html.not-ready").removeClass("not-ready").ckeditor({filebrowserImageUploadUrl:"/upload-img.php?sessionId="+localStorage.sessionId})}function g(){w.exec("info").then(function(e){e.me?(e.tables.map(function(e){M[e.url]=e.label}),K=n.render(a.createElement(P,{items:e.tables}),t.getElementById("container")),C=new S(e.me)):n.render(a.createElement(F,null),t.getElementById("container")),r.ready()})["catch"](function(){""===t.location.hash&&n.render(a.createElement(F,null),t.getElementById("container")),r.ready()})}function N(){return C||n.render(a.createElement(F,null),t.getElementById("container")),!!C}function S(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);if(this.userData){var a=new Uint8Array(u(localStorage.secretKey)),n=nacl.util.decodeBase64(this.userData),r=n.slice(0,24);try{var e=nacl.secretbox.open(n.slice(24),r,a);if(e===!1)throw new Error;this.data=JSON.parse(nacl.util.encodeUTF8(e))}catch(l){this.resetDatabase()}}else this.resetDatabase()}var w=new JSONful("/server.php");w.on("session",function(e){localStorage.sessionId=e}),"string"==typeof localStorage.sessionId&&w.setSession(localStorage.sessionId);var x=function(){function e(){var e={lines:13,length:11,width:5,radius:17,corners:1,rotate:0,color:"#FFF",speed:1,trail:60,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},n=t.createElement("div");t.body.appendChild(n);var r=new Spinner(e).spin(n);return a=iosOverlay({text:"Loading",spinner:r}),!1}var a;return{hide:function(){a&&(a.destroy(),a=null)},loading:function(){return e()}}}();w.on("request",function(){x.loading()}),w.on("response",function(){x.hide()});var C,k=(a.createClass({displayName:"CreateKeyModal",getInitialState:function(){return{scope:"",deployPhrase:""}},onSubmit:function(){var e=nacl.sign.keyPair(),t=new sjcl.cipher.aes(f(this.refs.pass1.value)),a={id:nacl.util.encodeBase64(e.publicKey),privKey:d(l(t,e.secretKey)),passAes:p("deploy",t),scope:this.refs.scope.value.split(/,+/g).map(function(e){return $.trim(e)})};w.exec("register-deploy-key",a).then(function(e){this.setState({publicKey:e.id})}.bind(this))},render:function(){var e=a.createElement("form",{className:"form-signin",onSubmit:this.onSubmit},a.createElement("label",{className:"sr-only"},"Deploy password"),a.createElement("input",{type:"password",ref:"pass1",className:"form-control",placeholder:"Password",required:!0}),a.createElement("label",{className:"sr-only"},"Scope (leave empty for global key)"),a.createElement("input",{type:"text",ref:"scope",className:"form-control",placeholder:"Scope"})),t=a.createElement("div",null,a.createElement("button",{type:"button",className:"btn btn-danger","data-dismiss":"modal"},"Cancel"),a.createElement("a",{type:"button",className:"btn btn-primary",onClick:this.onSubmit},"Create"));return this.state.publicKey&&(e=a.createElement("div",{className:"alert alert-success"},"Your public key is ",this.state.publicKey),t=a.createElement("div",null,a.createElement("button",{type:"button",className:"btn btn-primary","data-dismiss":"modal"},"Close"))),a.createElement("div",{className:"modal fade",id:"myModal",tabindex:"-1",role:"dialog","aria-labelledby":"myModalLabel"},a.createElement("div",{className:"modal-dialog",role:"document"},a.createElement("div",{className:"modal-content"},a.createElement("div",{className:"modal-header"},a.createElement("h4",{className:"modal-title",id:"myModalLabel"},"Create deploy key")),a.createElement("div",{className:"modalbody"},e),a.createElement("div",{className:"modal-footer"},t))))}}),a.createClass({displayName:"BabelUI",getInitialState:function(){return{strings:[]}},sendToBabel:function(){return confirm("Please review all the strings before sending to Babel. After sending to Babel our translators will start working on the strings. Are you sure the strings are ready?")&&w.exec("babel_push").then(function(e){this.setState({strings:e})}.bind(this)),!1},render:function(){return a.createElement("div",null,a.createElement("a",{onClick:this.sendToBabel,className:"btn btn-default"},"Send to Babel"),a.createElement("table",{className:"table table-striped"},a.createElement("thead",null,a.createElement("tr",null,a.createElement("td",null,"Context"),a.createElement("td",null,"Text"))),a.createElement("tbody",null,this.state.strings.map(function(e){return a.createElement("tr",{key:e.id},a.createElement("td",null,e.context),a.createElement("td",{dangerouslySetInnerHTML:{__html:e.text}}))}))))}})),_=a.createClass({displayName:"DeployCredentials",getInitialState:function(){return{error:null}},onSubmit:function(){var e=new sjcl.cipher.aes(f(this.refs.deployKey.value)),t=this.refs.remember.checked;this.setState({error:null}),w.exec("deploy-keys",{pass:p("deploy",e)}).then(function(a){var n=s(e,u(a.privKey));C.data["deploy-key"]=n,t&&(C.data["deploy-pass"]=p("deploy",e),C.saveData()),r.ready()})["catch"](function(e){this.setState({error:!0})}.bind(this))},render:function(){var e="";return this.state.error&&(e=a.createElement("div",{className:"alert alert-danger"},"Invalid deploy password")),a.createElement("div",null,a.createElement("form",{className:"form-signin",onSubmit:this.onSubmit},a.createElement("h2",{className:"form-signin-heading"},"Deploy passphrase"),e,a.createElement("label",{className:"sr-only"},"Password"),a.createElement("input",{type:"password",ref:"deployKey",className:"form-control",required:!0,autofocus:!0}),a.createElement("input",{type:"checkbox",value:"remember-me",ref:"remember"})," Remember me",a.createElement("button",{className:"btn btn-lg btn-primary btn-block",type:"submit"},"Prepare")))}}),I=a.createClass({displayName:"DeployList",getInitialState:function(){return{deploy:[]}},sign:function(e){var t=new Uint8Array(C.data["deploy-key"]);return nacl.util.encodeBase64(nacl.sign.detached(nacl.util.decodeBase64(e),t))},deploy:function(e){e.signature?e.signature=null:(e.signature=this.sign(e.hash),e.deps.forEach(function(e){e.signature=this.sign(e.hash)}.bind(this))),this.setState({deploy:this.state.deploy})},refresh:function(){w.exec("deploy").then(function(e){this.setState({deploy:e})}.bind(this))},deployAll:function(){var e={};this.state.deploy.forEach(function(t){t.signature&&(t.deps.forEach(function(t){e[t.hash]=t.signature}),e[t.hash]=t.signature)}),w.exec("sign",e,function(e){e&&alert(e.text)}),w.exec("deploy").then(function(e){this.setState({deploy:e})}.bind(this))},render:function(){var e,t=0;for(var n in this.state.deploy)this.state.deploy[n].signature&&t++;return t&&(e=a.createElement("a",{onClick:this.deployAll,className:"btn btn-danger"},"Deploy (",t," items)")),0===this.state.deploy.length?a.createElement("div",null,a.createElement("div",{className:"col-sm-12"},a.createElement("div",{className:"col-sm-8"},a.createElement("a",{onClick:this.refresh,className:"btn btn-success"},"Refresh")),a.createElement("div",{className:"col-sm-2"}),a.createElement("div",null,e||"")),a.createElement("p",null," "),a.createElement("div",{className:"col-sm-12"},a.createElement("div",{className:"alert alert-success"},"There is nothing to deploy"))):a.createElement("div",null,a.createElement("div",{className:"col-sm-12"},a.createElement("div",{className:"col-sm-8"},a.createElement("a",{onClick:this.refresh,className:"btn btn-success"},"Refresh")),a.createElement("div",{className:"col-sm-2"}),a.createElement("div",null,e||"")),a.createElement("table",{className:"table table-striped"},a.createElement("thead",null,a.createElement("tr",null,a.createElement("td",null,"Name"),a.createElement("td",null,"Size"),a.createElement("td",null,"Depedencies"),a.createElement("td",null,"#"))),a.createElement("tbody",null,this.state.deploy.map(function(e){var t=a.createElement("a",{className:"btn btn-success",onClick:this.deploy.bind(this,e)},"Approve"),n=[];return e.signature&&(t=a.createElement("a",{className:"btn disabled btn-success",onClick:this.deploy.bind(this,e)},"Approve")),e.mime.match(/image/)&&(e.name=a.createElement("img",{src:"/attach.php?id="+e.file_id,width:"150"})),e.deps.forEach(function(e){var t=a.createElement("span",{key:e.file_id},e.name);e.mime.match(/image/)&&(t=a.createElement("img",{key:e.file_id,src:"/attach.php?id="+e.file_id,width:"150"})),n.push(t)}),a.createElement("tr",{key:e.file_id},a.createElement("td",null,e.name),a.createElement("td",null,e.size),a.createElement("td",null,n),a.createElement("td",null,t))}.bind(this)))))}}),D={},B=a.createClass({displayName:"CrudInput",onChange:function(e){this.setState({value:e.target.value})},render:function(){var e=this.props.field,t=e.type;switch(this.state=this.state||{},this.state.value||(this.state.value=this.props.value||""),e.type){case"markdown":case"html":case"textarea":return a.createElement("textarea",{ref:e.name,className:"form-control not-ready "+e.type,extra:e.type,name:e.name,onChange:this.onChange,value:this.state.value});case"inline":return a.createElement("div",{className:"sub inline"},e.inputs.map(function(e,t){var n="field_"+this.props.id;return a.createElement("div",{className:"col-sm-6",key:"inline-input-"+t},a.createElement("div",{className:"form-group"},a.createElement("label",null,e.label),a.createElement(B,{field:e,ref:n,id:n,record_id:this.props.record_id,table:this.props.table,value:e.value||""})))}.bind(this)),a.createElement("div",{className:"clearfix"}));case"sub":return a.createElement("div",{className:"sub"},this.state.value.map(function(t,n){return a.createElement(R,{key:"sub-"+n+"_"+t.id,fields:t.form,table:"sub",sub:"sub",prefix:e.name+"."+n})}));case"upload":if(!this.props.record_id)return;return a.createElement(O,{name:e.name,url:"/upload.php?id="+this.props.record_id+"&table="+this.props.table+"&m=1",filter:e.extra,value:this.state.value,record_id:this.props.record_id,table:this.props.table,prefix:"/attach.php?id="});case"file":if(!this.props.record_id)return;return a.createElement(L,{name:e.name,url:"/upload.php?id="+this.props.record_id+"&table="+this.props.table,filter:e.extra,value:this.state.value,prefix:"/attach.php?id="});case"select":return a.createElement("select",{ref:e.name,className:"form-control",name:e.name,value:this.state.value,onChange:this.onChange},e.values.map(function(e,t){return a.createElement("option",{key:t,value:t},e)}.bind(this)))}return a.createElement("input",{type:t,ref:e.name,className:"form-control",value:this.state.value,name:e.name,placeholder:"",onChange:this.onChange})}}),A={},R=a.createClass({displayName:"CrudForm",componentDidMount:function(){setTimeout(y)},getData:function(){var e={};$(this.refs.form).serializeArray().map(function(t){var a=t.name.split(/\./g);if(1===a.length)return void(e[a[0]]=t.value);for(var n=e,r=0;r<a.length-1;++r)n[a[r]]||(n[a[r]]=isNaN(parseInt(n[a[r+1]]))?{}:[]),n=n[a[r]];n[a[r]]=t.value});for(var t in D)D.hasOwnProperty(t)&&(e[t]=D[t].value());return e},onSubmit:function(e){e.preventDefault(),delete A[this.props.id],this.saved=!0;var t=this.getData();return w.exec("save",{data:t,id:this.props.id,table:this.props.table,embed:this.props.embed}).then(function(e){this.props.embed?v("edit",this.props.embed.table,this.props.embed.id):v("list",this.props.table,1)}.bind(this))["catch"](function(e){alert("Error while saving the document:\n"+e.text)}),!1},componentWillUnmount:function(){if(this.saved||!A[this.props.id])return E();var e=this.getData();return A[this.props.id]=A[this.props.id].map(function(t){return t.value=e[t.name],t}),E()},render:function(){var e=this.props.fields.map(function(e,t){var n="field_"+(this.props.id||"");return this.props.prefix&&(e.name=this.props.prefix+"."+e.name),"children"===e.type?"":a.createElement("div",{className:"form-group",key:n+t},a.createElement("label",null,e.label),a.createElement(B,{ref:n,field:e,id:n,record_id:this.props.id,table:this.props.table,value:e.value||""}))}.bind(this)),t=this.props.fields.map(function(e,t){if("children"!==e.type)return"";var n=e.value;return a.createElement("div",{className:"form-group",key:"children-"+t},a.createElement("p",null," "),a.createElement(T,{fields:n.fields,table:n.table,pages:n.pages.pages,info:n.info||"",records:n.records,reference:[this.props.table,e.name,this.props.id]}))}.bind(this));return this.props.sub?a.createElement("div",null,e):a.createElement("form",{ref:"form"},e,a.createElement("button",{type:"button",onClick:this.onSubmit,className:"btn btn-default"},"Save"),t)}}),P=a.createClass({displayName:"Header",getInitialState:function(){return{currentCrud:null}},logout:function(){w.exec("logout").then(g)},render:function(){return a.createElement("div",null,a.createElement("nav",{className:"navbar navbar-inverse navbar-fixed-top"},a.createElement("div",{className:"container-fluid"},a.createElement("div",{className:"navbar-header"},a.createElement("button",{type:"button",className:"navbar-toggle collapsed","data-toggle":"collapse","data-target":"#navbar","aria-expanded":"false","aria-controls":"navbar"},a.createElement("span",{className:"sr-only"},"Toggle navigation"),a.createElement("span",{className:"icon-bar"}),a.createElement("span",{className:"icon-bar"}),a.createElement("span",{className:"icon-bar"})),a.createElement("a",{className:"navbar-brand",href:"#"},"Project name")),a.createElement("div",{id:"navbar",className:"navbar-collapse collapse"},a.createElement("ul",{className:"nav navbar-nav navbar-right"},a.createElement("li",null,a.createElement("a",{href:"#",onClick:this.logout},"Logout"))),a.createElement("form",{className:"navbar-form navbar-right"},a.createElement("input",{type:"text",className:"form-control",placeholder:"Search..."}))))),a.createElement("div",{className:"container-fluid"},a.createElement("div",{className:"row"},a.createElement("div",{className:"col-sm-3 col-md-2 sidebar"},a.createElement("ul",{className:"nav nav-sidebar"},this.props.items.map(function(e,t){return this.state.current===e.url?a.createElement("li",{className:"active",key:t},a.createElement("a",{href:r.url("list",e.url)},e.label)):a.createElement("li",{key:t},a.createElement("a",{href:r.url("list",e.url)},e.label))}.bind(this)))))),a.createElement("div",{id:"main",className:"col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main"},a.createElement("h1",{id:"title",className:"page-header"},M[this.state.current]),a.createElement("div",{id:"main_body"})),a.createElement("div",{id:"modals"}))}}),K=null,M={};g();var U=a.createClass({displayName:"Register",getInitialState:function(){return{user:null}},onSubmit:function(e){e.preventDefault();var t=this.refs.pass1.value,a=this.refs.pass2.value;if(!t)return this.setState({error:"You password cannot empty"});if(t.length<5)return this.setState({error:"Your password must be at least 5 letters long"});if(t!==a)return this.setState({error:"Your password doesn't match"});this.setState({error:null});var n=new sjcl.cipher.aes(f(t)),r=nacl.box.keyPair();w.exec("confirm_registration",{id:this.state.user.id,hash:this.props.hash,publicKey:d(r.publicKey),secretKey:d(l(n,r.secretKey)),login_hash:p(this.state.user.email,n)}).then(function(){this.setState({success:!0,message:"Your account is activated, please login"})}.bind(this))["catch"](function(e){this.setState({error:e.text})}.bind(this))},render:function(){if(this.state.success||this.state.fatalError){var e=this.state.success?"info":"danger";return a.createElement("div",null,a.createElement("form",{className:"form-signin",onSubmit:this.onSubmit},a.createElement("div",{className:"alert alert-"+e},this.state.message)))}if(!this.state.user)return a.createElement("div",null,a.createElement("form",{className:"form-signin",onSubmit:this.onSubmit},a.createElement("div",null,"Loading")));var t;return this.state.error&&(t=a.createElement("div",{className:"alert alert-danger"},this.state.error)),a.createElement("div",null,a.createElement("form",{className:"form-signin",onSubmit:this.onSubmit},a.createElement("h2",{className:"form-signin-heading"},"Welcome ",this.state.user.email),a.createElement("div",{className:"alert alert-info"},"You are about to create your password for MEGA's CMS admin. ",a.createElement("br",null),"Please choose a strong password."),t,a.createElement("label",{className:"sr-only"},"Password"),a.createElement("input",{type:"password",ref:"pass1",className:"form-control",placeholder:"Password",required:!0}),a.createElement("label",{className:"sr-only"},"Repeat Password"),a.createElement("input",{type:"password",ref:"pass2",className:"form-control",placeholder:"Repeat Password",required:!0}),a.createElement("div",{className:"checkbox"}),a.createElement("button",{className:"btn btn-lg btn-primary btn-block",type:"submit"},"Register")))}}),F=a.createClass({displayName:"LoginList",getInitialState:function(){return{error:!1}},onSubmit:function(e){e.preventDefault();var t=this,a=new sjcl.cipher.aes(f(this.refs.inputPassword.value));w.exec("login",{hash:p(this.refs.inputEmail.value,a)})["catch"](function(){t.setState({error:!0})}).then(function(e){e&&(localStorage.publicKey=e.publicKey,localStorage.secretKey=d(s(a,u(e.secretKey))),g())})},render:function(){var e=[];return this.state.error&&(e=a.createElement("div",{className:"alert alert-danger"},"Invalid username or password")),a.createElement("div",null,a.createElement("form",{className:"form-signin",onSubmit:this.onSubmit},a.createElement("h2",{className:"form-signin-heading"},"Please sign in"),e,a.createElement("label",{className:"sr-only"},"Email address"),a.createElement("input",{type:"email",ref:"inputEmail",className:"form-control",placeholder:"Email address",required:!0,autofocus:!0}),a.createElement("label",{className:"sr-only"},"Password"),a.createElement("input",{type:"password",ref:"inputPassword",className:"form-control",placeholder:"Password",required:!0}),a.createElement("div",{className:"checkbox"},a.createElement("label",null,a.createElement("input",{type:"checkbox",value:"remember-me"})," Remember me")),a.createElement("button",{className:"btn btn-lg btn-primary btn-block",type:"submit"},"Sign in")))}});r.route("register/:hash",function(e){var r=n.render(a.createElement(U,{hash:e}),t.getElementById("container"));w.exec("register",{hash:e}).then(function(e){r.setState({user:e})})["catch"](function(){r.setState({fatalError:!0,message:"The link is no longer valid"})})}),r.addFilter("page",function(e){return e=parseInt(e),e>0}),r.route("edit-push/:table/:id/:parent_id/:parent_prop/:parent_table",function(e,r,l,s,i){K.setState({current:e});var o={id:l,prop:s,table:i};return A[r]?void n.render(a.createElement(R,{fields:A[r],table:e,id:r,embed:o,key:Math.random()}),t.getElementById("main_body")):void w.exec("form",{table:e,id:r}).then(function(l){A[r]=l,n.render(a.createElement(R,{fields:l,table:e,id:r,embed:o,key:Math.random()}),t.getElementById("main_body"))})}).name("edit_push").preRoute(N),r.route("push/:table/:parent_id/:parent_prop/:parent_table",function(e,r,l,s){K.setState({current:e});var i={id:r,prop:l,table:s};w.exec("form",{table:e}).then(function(r){n.render(a.createElement(R,{fields:r,table:e,id:"new",embed:i,key:Math.random()}),t.getElementById("main_body"))})}).name("push").preRoute(N),r.route("new/:table",function(e){K.setState({current:e}),w.exec("form",{table:e}).then(function(r){n.render(a.createElement(R,{fields:r,table:e,id:"new",key:Math.random()}),t.getElementById("main_body"))})}).name("create").preRoute(N),r.route("list/babelstring/:page",function(){K.setState({current:"Babel Synchronization"}),w.exec("babel").then(function(e){n.render(a.createElement(k,null),t.getElementById("main_body")).setState({strings:e})})}),r.route("list/deploy_keys/:page",function(){K.setState({current:"Deploy Keys"}),w.exec("get_js_embed").then(function(e){n.render(a.createElement("pre",null,a.createElement("code",{className:"javascript"},e.code)),t.getElementById("main_body")),hljs.highlightBlock($("code")[0])})}),r.route("list/deploy/:page",function(e){return C.canDeploy()?(K.setState({current:"Deploy"}),void w.exec("deploy").then(function(e){n.render(a.createElement(I,null),t.getElementById("main_body")).setState({deploy:e})})):void n.render(a.createElement(_,null),t.getElementById("main_body"))}).preRoute(N),r.route("list/:table/:page",function(e,r){K.setState({current:e}),w.exec("list",{table:e,page:r}).then(function(r){var l=n.render(a.createElement(T,{fields:r.fields,table:e,pages:r.pages.pages,info:r.info||""}),t.getElementById("main_body"));l.setState({records:r.records})})}).name("list").setDefault("page",1).preRoute(N),r.route("edit/:table/:id",function(e,r){return A[r]?void n.render(a.createElement(R,{fields:A[r],table:e,id:r,key:Math.random()}),t.getElementById("main_body")):void w.exec("form",{table:e,id:r}).then(function(l){A[r]=l,n.render(a.createElement(R,{fields:l,table:e,id:r,key:Math.random()}),t.getElementById("main_body"))})}).name("edit").preRoute(N);var T=a.createClass({displayName:"CrudList",getInitialState:function(){return{records:this.props.records||[]}},"delete":function(e){if(confirm("Are you sure to delete this entry? There is no wayback")){var t=e.currentTarget;w.exec("delete",{id:t.getAttribute("data-id"),table:this.props.table,parent:this.props.reference||null}).then(function(e){this.setState(e)}.bind(this))}return!1},render:function(){var e="Create",t=r.url("create",this.props.table);return this.props.reference&&(e="Create "+this.props.reference[1],t=r.url("push",this.props.table,this.props.reference[2],this.props.reference[1],this.props.reference[0])),a.createElement("div",null,a.createElement("div",null,a.createElement("em",null,this.props.info)),a.createElement("a",{href:t,className:"btn btn-success"},e),a.createElement("table",{className:"table table-striped"},a.createElement("thead",null,a.createElement("tr",null,this.props.fields.map(function(e,t){return a.createElement("th",{key:t},e)}),a.createElement("th",{className:"buttons"},"#"))),a.createElement("tbody",null,this.state.records.map(function(e,t){var n=r.url("edit",this.props.table,e.id);return this.props.reference&&(n=r.url("edit_push",this.props.table,e.id,this.props.reference[2],this.props.reference[1],this.props.reference[0])),a.createElement("tr",{key:t},this.props.fields.map(function(t,n){return a.createElement("td",{key:n},e[t])}),a.createElement("td",{className:"buttons"},a.createElement("a",{href:n,className:"btn btn-success"},"Edit"),a.createElement("a",{onClick:this["delete"],"data-id":e.id,className:"btn btn-danger"},"Delete")))}.bind(this)))),a.createElement("nav",null,a.createElement("ul",{className:"pagination"},this.props.pages.map(function(e,t){return a.createElement("li",{key:t},a.createElement("a",{href:r.url("list",this.props.table,e)},e))}.bind(this)))))}}),j={getInitialState:function(){return{value:"",file:!1,progress:null}},result:function(){var e=[a.createElement("div",{className:"alert "+(this.state.error?"alert-danger":"alert-success")},this.state.result)];return this.state.error&&e.push(a.createElement("button",{className:"btn btn-default",onClick:this.beginUpload},"Retry upload")),e},beginUpload:function(){var e=this,t=new FormData,a=new XMLHttpRequest;t.append("sessionId",localStorage.sessionId),t.append(this.props.name,this.state.file),a.onload=function(){var t="string"==typeof this.response?JSON.parse(this.response||this.responseText):this.response;e.props.value=t[0],e.setState({result:"File was uploaded successfully",value:t})},a.onerror=function(){e.setState({error:!0,result:"Upload failed."})},a.upload.onprogress=function(t){t.lengthComputable&&e.setState({progress:Math.max(1,Math.ceil(100*(t.loaded/t.total)))})},a.open("POST",this.props.url),a.responseType="json",a.send(t),e.setState({progress:0})},onChange:function(e){var t=new RegExp(this.props.filter,"i"),a=e.target.files[0];return(a.type||"").match(t)?(this.setState({file:a}),!1):(alert("Invalid file name, "+this.props.filter+" is expected"),!1)}},O=a.createClass({displayName:"MultiFileUploadInput",mixins:[j],"delete":function(e){confirm("Are you sure to delete this file?")&&w.exec("delete_file",{field:this.props.name,fileId:e.id,table:this.props.table,id:this.props.record_id},function(e){this.setState({value:e.response})}.bind(this))},values:function(){return a.createElement("table",{className:"table table-striped"},a.createElement("thead",null,a.createElement("tr",null,a.createElement("th",null,"Object ID"),a.createElement("th",null,"Mime type"),a.createElement("th",null,"Preview "))),a.createElement("tbody",null,(this.state.value||this.props.value||[]).map(function(e,t){return a.createElement("tr",{key:t},a.createElement("td",null,e.id),a.createElement("td",null,e.mime.match(/image/)?a.createElement("img",{src:this.props.prefix+e.id,width:"300px"}):e.mime),a.createElement("td",null,a.createElement("a",{className:"btn btn-danger",onClick:this["delete"].bind(this,e)},"Delete")))}.bind(this))))},render:function(){return this.state.result?a.createElement("div",null,a.createElement("div",null,this.result()),a.createElement("div",null,this.values())):this.state.file?a.createElement("div",null,a.createElement("div",null,"Upload file ",this.state.file.name," (",humanFormat(this.state.file.size),")."),a.createElement("div",null,a.createElement("button",{className:"btn btn-default",onClick:this.beginUpload},"Begin upload")),a.createElement("div",null,this.values())):a.createElement("div",null,a.createElement("h4",null,"Add new file"),a.createElement("input",{type:"file",onChange:this.onChange}),a.createElement("h4",null,"Values"),this.values())}}),L=a.createClass({displayName:"FileUploadInput",mixins:[j],value:function(){var e=this.props.value;return e?a.createElement("img",{src:this.props.prefix+e,width:"300px"}):void 0},render:function(){var e=this.state.file;return this.state.result?a.createElement("div",null,a.createElement("div",null,this.result()),a.createElement("div",null,this.value())):"number"==typeof this.state.progress?a.createElement("div",null,a.createElement("div",null,"Upload file ",e.name," (",humanFormat(e.size),")."),a.createElement("div",null,"Uploading ",this.state.progress,"%"),a.createElement("div",null,this.value())):e?a.createElement("div",null,a.createElement("div",null,"Upload file ",e.name," (",humanFormat(e.size),")."),a.createElement("div",null,a.createElement("button",{className:"btn btn-default",onClick:this.beginUpload},"Begin upload")),a.createElement("div",null,this.value())):a.createElement("div",null,a.createElement("input",{type:"file",onChange:this.onChange,value:this.state.value}),a.createElement("div",null,this.value()))}});S.prototype.canDeploy=function(){return this.data["deploy-key"]},S.prototype.resetDatabase=function(){return this.data={},this.saveData(),!0},S.prototype.saveData=function(){for(var e=JSON.stringify(this.data),t=new Uint8Array(u(localStorage.secretKey)),a=nacl.randomBytes(24),n=nacl.secretbox(nacl.util.decodeUTF8(e),a,t),r=new Uint8Array(a.length+n.length),l=0;l<a.length;++l)r[l]=a[l];for(var s=0;s<n.length;++s)r[s+l]=n[s];return w.exec("store",{data:nacl.util.encodeBase64(r)}),this}}(window,document,React,ReactDOM,hRouter);